<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Weekly Meal Planner</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      max-width: 520px;
      margin: auto;
    }
    h1 {
      text-align: center;
    }
    .controls {
      text-align: center;
      margin-bottom: 16px;
    }
    .row {
      border-bottom: 1px solid #ddd;
      padding: 12px 0;
    }
    select, button {
      margin-left: 6px;
      margin-top: 6px;
    }
    a {
      margin-left: 6px;
    }
    button.locked {
      opacity: 0.5;
    }
  </style>
</head>

<body>

<h1>Weekly Meal Planner</h1>

<div class="controls">
  <button id="generateAll">üîÅ Generate Whole Week</button>
  <button id="viewCalendar">üìÖ View Weekly Calendar</button>
</div>


<div id="planner">Loading‚Ä¶</div>

<script>
/* ===================== CONFIG ===================== */

const SHEET_ID = "1S_NX1UxOB38aB-9As9gC8zH4BQMSuONk4g7f5jL8nmE";

const PROTEIN_TAGS = ["beef", "chicken", "lamb", "fish", "tofu", "tempe"];
const CUISINE_TAGS = ["italian", "indonesian", "mediterranean", "asian", "mexican"];
const selectedMeals = {};

/* ===================== DATA URLS ===================== */

const RECIPES_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=0`;

const PLAN_URL =
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=2118385531`;

/* ===================== CSV PARSER ===================== */

function parseCSV(text) {
  const rows = [];
  let row = [], val = "", inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i], n = text[i + 1];

    if (c === '"' && inQuotes && n === '"') {
      val += '"';
      i++;
    } else if (c === '"') {
      inQuotes = !inQuotes;
    } else if (c === "," && !inQuotes) {
      row.push(val);
      val = "";
    } else if (c === "\n" && !inQuotes) {
      row.push(val);
      rows.push(row.map(v => v.trim()));
      row = [];
      val = "";
    } else {
      val += c;
    }
  }

  if (val || row.length) {
    row.push(val);
    rows.push(row.map(v => v.trim()));
  }

  return rows;
}

/* ===================== APP STATE ===================== */

const locks = {};   // key = "Monday-Dinner" ‚Üí true/false
const generateFns = []; // store per-row generate functions

/* ===================== LOAD DATA ===================== */

Promise.all([
  fetch(RECIPES_URL).then(r => r.text()),
  fetch(PLAN_URL).then(r => r.text())
])
.then(([recipesCSV, planCSV]) => {

  const recipes = parseCSV(recipesCSV)
    .slice(1)
    .map(r => ({
      name: r[1],
      url: r[2],
      tags: (r[3] || "").toLowerCase()
    }));

  const plan = parseCSV(planCSV).slice(1);
  const container = document.getElementById("planner");
  container.innerHTML = "";

  const headers = parseCSV(planCSV)[0].map(h => h.toLowerCase());

const dayIndex = headers.indexOf("day");
const mealIndex = headers.indexOf("meal");

plan.forEach(p => {
  const day = p[dayIndex];
  const meal = p[mealIndex];

    const key = `${day}-${meal}`;
    locks[key] = false;

    const row = document.createElement("div");
    row.className = "row";

    const label = document.createElement("strong");
    label.textContent = `${day} ${meal}`;

    /* Protein dropdown */
    const proteinSelect = document.createElement("select");
    proteinSelect.innerHTML = `<option value="">Any protein</option>`;
    PROTEIN_TAGS.forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t[0].toUpperCase() + t.slice(1);
      proteinSelect.appendChild(o);
    });

    /* Cuisine dropdown */
    const cuisineSelect = document.createElement("select");
    cuisineSelect.innerHTML = `<option value="">Any cuisine</option>`;
    CUISINE_TAGS.forEach(t => {
      const o = document.createElement("option");
      o.value = t;
      o.textContent = t[0].toUpperCase() + t.slice(1);
      cuisineSelect.appendChild(o);
    });

    const genBtn = document.createElement("button");
    genBtn.textContent = "Generate";

    const lockBtn = document.createElement("button");
    lockBtn.textContent = "üîì";

    const result = document.createElement("span");

    /* Generate logic with smart fallback */
    const generate = () => {
      if (locks[key]) return;

      const protein = proteinSelect.value;
      const cuisine = cuisineSelect.value;

      let pool = recipes.filter(r => {
        const tags = r.tags.split(",").map(t => t.trim());
        if (protein && !tags.includes(protein)) return false;
        if (cuisine && !tags.includes(cuisine)) return false;
        return true;
      });

      if (!pool.length && protein)
        pool = recipes.filter(r => r.tags.includes(protein));

      if (!pool.length && cuisine)
        pool = recipes.filter(r => r.tags.includes(cuisine));

      if (!pool.length)
        pool = recipes;

      const pick = pool[Math.floor(Math.random() * pool.length)];
      result.innerHTML = ` <a href="${pick.url}" target="_blank">${pick.name}</a>`;
selectedMeals[key] = {
  day,
  meal,
  name: pick.name,
  url: pick.url
};


    genBtn.onclick = generate;
    generateFns.push(generate);

    /* Lock logic */
    lockBtn.onclick = () => {
      locks[key] = !locks[key];
      lockBtn.textContent = locks[key] ? "üîí" : "üîì";
      genBtn.disabled = locks[key];
      genBtn.classList.toggle("locked", locks[key]);
    };

    row.append(label, proteinSelect, cuisineSelect, genBtn, lockBtn, result);
    container.appendChild(row);
  });

  /* Generate whole week */
  document.getElementById("generateAll").onclick = () => {
    generateFns.forEach(fn => fn());
  };

})
.catch(err => {
  console.error(err);
  document.getElementById("planner").textContent = "Failed to load menu.";
});
  document.getElementById("viewCalendar").onclick = () => {
  const win = window.open("", "_blank");

  let html = `
    <html>
    <head>
      <title>Weekly Meal Calendar</title>
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          padding: 24px;
        }
        h2 {
          border-bottom: 2px solid #000;
          padding-bottom: 4px;
        }
        .meal {
          margin-left: 12px;
          margin-bottom: 6px;
        }
      </style>
    </head>
    <body>
      <h1>Weekly Meal Plan</h1>
  `;

  const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];

  days.forEach(d => {
    html += `<h2>${d}</h2>`;

    ["Lunch","Dinner"].forEach(m => {
      const key = `${d}-${m}`;
      const entry = selectedMeals[key];

      if (entry) {
        html += `
          <div class="meal">
            <strong>${m}:</strong>
            <a href="${entry.url}" target="_blank">${entry.name}</a>
          </div>
        `;
      } else {
        html += `
          <div class="meal">
            <strong>${m}:</strong> ‚Äî
          </div>
        `;
      }
    });
  });

  html += `</body></html>`;
  win.document.write(html);
  win.document.close();
};

</script>

</body>
</html>
